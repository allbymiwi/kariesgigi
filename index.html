<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>kARies ‚Äî WebXR Plane Placement</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { margin:0; height:100%; overflow:hidden; font-family:"Poppins",sans-serif; background:#f0f4f9; }
    canvas { display:block; }

    /* UI (mirip dengan yang lo suka) */
    #ui {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      pointer-events: none;
      z-index: 10;
    }

    #bars {
      position: absolute;
      top: 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      pointer-events: none;
      width: calc(100% - 32px);
      max-width: 420px;
    }

    .status-bar {
      display:flex; align-items:center;
      background:rgba(60,60,60,0.85); border-radius:18px;
      padding:6px 10px; min-width:240px; height:32px; box-shadow:0 3px 6px rgba(0,0,0,0.18);
    }
    .status-icon { width:26px; height:26px; margin-right:8px; }
    .status-label { color:#fff; font-size:13px; font-weight:600; margin-right:10px; min-width:80px; }
    .bar-fill { flex:1; height:22px; border-radius:12px; background:#444; overflow:hidden; position:relative; }
    .bar-inner { height:100%; width:100%; border-radius:12px; transition:width .35s ease; }
    .clean .bar-inner { background: linear-gradient(to right,#4fc3f7,#0288d1); }
    .health .bar-inner { background: linear-gradient(to right,#ef9a9a,#e57373); }
    .bar-inner.damage { animation: blinkRed .45s ease; }
    @keyframes blinkRed { 0%,100%{filter:brightness(1);} 50%{filter:brightness(2);} }

    #buttons {
      width:100%; max-width:420px; display:flex; gap:18px; justify-content:center; margin-bottom:20px; pointer-events:auto;
    }
    .action-btn { display:flex; flex-direction:column; align-items:center; background:none; border:none; cursor:pointer; transition:transform .12s ease; }
    .action-btn img { width:62px; height:62px; border-radius:50%; padding:8px; background:#fff; box-shadow:0 3px 8px rgba(0,0,0,0.22); margin-bottom:6px; object-fit:contain; }
    .action-btn span { font-size:13px; font-weight:600; color:#fff; text-shadow:0 1px 4px rgba(0,0,0,0.35); }
    .action-btn.brush img { background:#b2e8ff; }
    .action-btn.healthy img { background:#c8f7c2; }
    .action-btn.sweet img { background:#ffd4e1; }

    #infoText {
      background: rgba(255,255,255,0.95);
      border-radius:12px; padding:8px 12px; margin-bottom:12px;
      font-size:13px; font-weight:500; color:#0b4f8a; box-shadow:0 2px 10px rgba(0,0,0,0.12);
      text-align:center; max-width:360px; pointer-events:auto; transition:opacity .22s ease;
    }

    /* small-device tweak */
    @media (max-width:420px) {
      .status-bar { min-width:220px; height:28px; padding:5px 8px; }
      .status-label { min-width:60px; font-size:12px; }
      .action-btn img { width:54px; height:54px; padding:6px; }
    }

    /* top-left small info */
    #topInfo {
      position:absolute; left:12px; top:12px; z-index:11;
      background: rgba(255,255,255,0.95); padding:8px 10px; border-radius:10px; font-weight:600; color:#0b4f8a;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      pointer-events:none;
    }

    /* fallback message when no WebXR */
    #fallback {
      position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:20;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); text-align:center; padding:18px;
    }
    #enter-ar-hint { margin-top:8px; font-size:13px; color:#666; }

  </style>
</head>
<body>
  <div id="topInfo">Arahkan kamera ke permukaan datar. Ketuk layar untuk menempatkan model saat berada dalam mode AR.</div>

  <div id="fallback">
    <div>
      <h3>Perangkat/browser tidak mendukung WebXR AR</h3>
      <p>Fitur plane-detection (WebXR hit-test) memerlukan Chrome (Android) dengan ARCore atau browser perangkat yang mendukung <code>immersive-ar</code>.</p>
      <p>Kalau perangkat tidak mendukung, gunakan versi marker (dengan marker.patt) atau tes pada perangkat Android yang mendukung.</p>
    </div>
  </div>

  <!-- UI Overlay -->
  <div id="ui">
    <div id="bars">
      <div class="status-bar clean">
        <img src="icons/water.png" class="status-icon" alt="Kebersihan" />
        <span class="status-label">Kebersihan</span>
        <div class="bar-fill"><div id="cleanFill" class="bar-inner" style="width:100%"></div></div>
      </div>

      <div class="status-bar health">
        <img src="icons/heart.png" class="status-icon" alt="Kesehatan" />
        <span class="status-label">Kesehatan</span>
        <div class="bar-fill"><div id="healthFill" class="bar-inner" style="width:100%"></div></div>
      </div>
    </div>

    <div id="infoText">Tekan tombol "Enter AR" (jika muncul) lalu arahkan ke meja/permukaan. Ketuk layar untuk menaruh model.</div>

    <div id="buttons">
      <button class="action-btn brush" id="btnBrush" onclick="setAction('brush')">
        <img src="icons/sikat.png" alt="Gosok Gigi" />
        <span>Gosok Gigi</span>
      </button>

      <button class="action-btn healthy" id="btnHealthy" onclick="setAction('healthy')">
        <img src="icons/wortel.png" alt="Makanan Sehat" />
        <span>Makanan Sehat</span>
      </button>

      <button class="action-btn sweet" id="btnSweet" onclick="setAction('sweet')">
        <img src="icons/permen.png" alt="Makanan Manis" />
        <span>Makanan Manis</span>
      </button>
    </div>
  </div>

  <!-- three.js + ARButton -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';

    // UI refs
    const infoText = document.getElementById('infoText');
    const cleanFill = document.getElementById('cleanFill');
    const healthFill = document.getElementById('healthFill');
    const fallback = document.getElementById('fallback');

    // game state (same logic as sebelumnya)
    let cleanValue = 100;
    let healthValue = 100;
    let sweetCount = 0;

    // three.js + XR vars
    let camera, scene, renderer;
    let controller;
    let reticle;
    let hitTestSource = null;
    let hitTestSourceRequested = false;
    let toothGltf = null;    // loaded model scene (clone on placement)
    let placedAny = false;   // whether model placed at least once

    init();
    animate();

    function init() {
      // renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // scene & camera
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

      // light
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      scene.add(light);

      // Reticle as placement preview (ring)
      const ringGeom = new THREE.RingGeometry(0.07, 0.09, 32).rotateX(-Math.PI/2);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc, opacity: 0.9, transparent: true });
      reticle = new THREE.Mesh(ringGeom, ringMat);
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // controller for input (tap to place)
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);

      // ARButton - requests hit-test feature
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // load model (tooth.glb) from root
      const loader = new GLTFLoader();
      loader.load('tooth.glb',
        (gltf) => {
          toothGltf = gltf.scene;
          // default scale; adjust as needed
          toothGltf.scale.set(0.4, 0.4, 0.4);
          console.log('tooth model loaded');
        },
        undefined,
        (err) => { console.error('GLTF load error', err); fadeInfo('Gagal load model. Cek tooth.glb'); }
      );

      // handle resize
      window.addEventListener('resize', onWindowResize);

      // feature detect WebXR
      if (navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
          if (!supported) showFallback();
        }).catch(() => { showFallback(); });
      } else {
        showFallback();
      }

      // pointer hint: if user taps outside AR session, offer to start (ARButton handles start)
      window.addEventListener('pointerdown', () => {
        // small visual hint if not in AR session
        if (!renderer.xr.isPresenting) {
          fadeInfo('Tekan "Enter AR" (jika muncul) lalu ketuk layar untuk menempatkan model.');
        }
      });
    }

    function showFallback() {
      fallback.style.display = 'flex';
      infoText.style.display = 'none';
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // called when user taps screen in AR session (select event)
    function onSelect() {
      if (!reticle.visible) {
        fadeInfo('Pindahkan kamera sedikit sampai reticle (lingkaran) muncul di permukaan.');
        return;
      }
      if (!toothGltf) {
        fadeInfo('Model belum siap, tunggu sebentar...');
        return;
      }

      // clone and place model at reticle pose
      const placed = toothGltf.clone(true);
      placed.matrixAutoUpdate = false;
      placed.applyMatrix4(reticle.matrix);
      scene.add(placed);
      placedAny = true;
      fadeInfo('Model ditempatkan! Sekarang coba tombol di bawah.');
      updateBars(); // ensure bars visible
    }

    // main render loop
    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
      if (frame) {
        const session = renderer.xr.getSession();
        if (session && !hitTestSourceRequested) {
          session.requestReferenceSpace('viewer').then((refSpace) => {
            session.requestHitTestSource({ space: refSpace }).then((source) => {
              hitTestSource = source;
            });
          });
          session.addEventListener('end', () => {
            hitTestSourceRequested = false;
            hitTestSource = null;
            reticle.visible = false;
          });
          hitTestSourceRequested = true;
        }

        if (hitTestSource) {
          const referenceSpace = renderer.xr.getReferenceSpace();
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if (hitTestResults.length > 0) {
            const hit = hitTestResults[0];
            const pose = hit.getPose(referenceSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        }
      }

      renderer.render(scene, camera);
    }

    /* ===========================
       UI & game logic (same behavior)
       =========================== */

    function fadeInfo(text, ms = 220) {
      infoText.style.opacity = 0;
      setTimeout(() => { infoText.textContent = text; infoText.style.opacity = 1; }, ms);
    }

    function updateBars() {
      // clamp and update
      cleanValue = Math.max(0, Math.min(100, cleanValue));
      healthValue = Math.max(0, Math.min(100, healthValue));
      if (cleanFill) cleanFill.style.width = cleanValue + '%';
      if (healthFill) healthFill.style.width = healthValue + '%';
    }

    function addHealthDamageFlash() {
      const el = document.querySelector('.health .bar-inner');
      if (!el) return;
      el.classList.add('damage');
      setTimeout(() => el.classList.remove('damage'), 500);
    }

    // setAction exposed to onclick in HTML
    window.setAction = function(action) {
      // require that at least one model has been placed
      if (!placedAny) {
        fadeInfo('Tempatkan model dulu (ketuk layar saat mode AR aktif) baru gunakan tombol.');
        return;
      }

      switch(action) {
        case 'brush':
          cleanValue = 100;
          healthValue = 100;
          sweetCount = 0;
          fadeInfo('ü™• Gigi bersih total! Sehat kembali ‚ú®');
          break;

        case 'sweet':
          cleanValue -= 12.5;
          sweetCount++;
          if (sweetCount >= 2) {
            sweetCount = 0;
            healthValue -= 25;
            addHealthDamageFlash();
            fadeInfo('‚ö†Ô∏è Terlalu sering makan manis! Kesehatan menurun!');
          } else {
            fadeInfo('üç≠ Gula menempel! Kebersihan menurun sedikit...');
          }
          break;

        case 'healthy':
          fadeInfo('ü•¶ Makanan sehat baik untuk gigi, namun harus tetap menggosok gigi ya!');
          break;

        default:
          console.warn('Unknown action', action);
      }

      cleanValue = Math.max(0, cleanValue);
      healthValue = Math.max(0, healthValue);
      updateBars();

      if (healthValue <= 0) {
        fadeInfo('üíÄ Kritis! Gigi rusak total ‚Äî lakukan perawatan!');
      }
    };

  </script>

</body>
</html>
